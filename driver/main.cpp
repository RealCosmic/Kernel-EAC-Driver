

#include <driver/xorstr.h>
#include <system/funcs.h>
#include <core/hook.h>
#include <driver/include.h>

extern "C" NTSTATUS DriverEntry( PDRIVER_OBJECT, PUNICODE_STRING )
{

	uintptr_t win32k = system::get_system_module(XORS(L"win32k.sys"));
	if (!win32k)
	{
		printf("win32k.sys not found in system modules, unable to load driver.\n");
		return STATUS_ABANDONED;
	}
	core_hook::fptr_addr = system::find_pattern(win32k, XORS("\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x06\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x28\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x28\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x06\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x28\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x28\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x08\xFF\x15\x00\x00\x00\x00\xEB\x05\xB8\x00\x00\x00\x00\x48\x83\xC4\x28\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x28\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x06\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x28\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x28\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x06\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x28\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x28\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x06\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x28\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x28\x48\x8B\x05\x00\x00\x00\x00\x48\x85\xC0\x74\x06\xFF\x15\x00\x00\x00\x00\x48\x83\xC4\x28\xC3\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\xCC\x48\x83\xEC\x38"), XORS("xxx????xxxxxxx????xxxxxxxxxxxxxxxxxxxxx????xxxxxxx????xxxxxxxxxxxxxxxxxxxxx????xxxxxxx????xxx????xxxxxxxxxxxxxxxxxxxxxx????xxxxxxx????xxxxxxxxxxxxxxxxxxxxx????xxxxxxx????xxxxxxxxxxxxxxxxxxxxx????xxxxxxx????xxxxxxxxxxxxxxxxxxxxx????xxxxxxx????xxxxxxxxxxxxxxxxxx"));

	if (!core_hook::fptr_addr)
	{
		printf("unable to find target function.\n");
		return STATUS_UNSUCCESSFUL;

	}
	printf("NtUserCompositionInputSinkViewInstanceIdFromPoint: 0x%llx\n", core_hook::fptr_addr);


	//uint32_t core_count = KeQueryActiveProcessorCount(nullptr);

	*(void**)&core_hook::o_function_qword_1 = InterlockedExchangePointer((void**)dereference(core_hook::fptr_addr), (void*)core_hook::hooked_fptr);
	
	printf("driver successfully loaded.\n");
	return STATUS_SUCCESS;
}